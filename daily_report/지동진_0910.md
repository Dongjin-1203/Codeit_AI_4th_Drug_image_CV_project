# 지동진 25년 09월 19일 일일 활동 결과: RT-DETR 알약 객체인식 모델 성능 보고서

## 1. RT-DETR 모델 개요

### 1.1 모델 설명
RT-DETR(Real-Time Detection Transformer)은 Baidu에서 개발한 실시간 객체 탐지 모델로, DETR의 end-to-end 학습 장점을 유지하면서 실시간 추론이 가능하도록 최적화된 모델입니다.

**주요 특징:**
- **End-to-End 학습**: NMS 후처리 과정 없이 직접 최종 예측 수행
- **실시간 추론**: 기존 DETR 대비 빠른 추론 속도
- **고성능 백본**: ResNet, EfficientNet 등 다양한 백본 네트워크 지원
- **유연한 아키텍처**: 다양한 크기(S, M, L, X) 모델 제공

### 1.2 모델 선택 배경
기존 YOLO 및 DETR 모델 대비 RT-DETR을 선택한 이유:

| 모델 | 장점 | 단점 | 알약 탐지 적합성 |
|------|------|------|------------------|
| **YOLO** | 빠른 속도, 안정적 성능 | 앵커 기반, 복잡한 후처리 | 보통 |
| **DETR** | End-to-end, 높은 정확도 | 느린 수렴, 실시간 추론 어려움 | 높음 |
| **RT-DETR** | End-to-end + 실시간, 균형잡힌 성능 | 상대적으로 새로운 모델 | **최적** |

**RT-DETR 선택 이유:**
- 기존 YOLO 모델로는 성능 향상이 제한적
- 순수 DETR은 추론 속도가 느려 실용성 부족
- RT-DETR은 정확도와 속도의 최적 균형점 제공
- 의료용 알약처럼 정밀한 탐지가 필요한 도메인에 적합

## 2. End-to-End 아키텍처

### 2.1 전체 파이프라인
```
Raw Images → Data Preprocessing → RT-DETR Training → Model Inference → CSV Submission
```

### 2.2 상세 아키텍처

#### 데이터 전처리 단계
```
COCO JSON Files → YOLO Format Conversion → Train/Val Split → Category Mapping
```

#### 모델 학습 단계
```
Input Images (640×640) → ResNet Backbone → Transformer Encoder → 
Transformer Decoder → Classification + Regression Heads → Loss Computation
```

#### 추론 단계
```
Test Images → RT-DETR Model → Direct Predictions → 
Category ID Mapping → CSV Export
```

### 2.3 핵심 구성요소
- **백본 네트워크**: ResNet 기반 특징 추출
- **트랜스포머 인코더**: 전역 특징 관계 학습
- **트랜스포머 디코더**: 객체 쿼리 기반 탐지
- **예측 헤드**: 분류 및 바운딩 박스 회귀

## 3. 구현 코드 구조

### 3.1 주요 클래스
```python
class RTDETRDataProcessor:
    # COCO 형식 데이터를 YOLO 형식으로 변환하는 전처리 클래스
    def __init__(self, data_path)                        # 데이터 경로 설정 및 출력 디렉토리 생성
    def merge_coco_annotations(self)                     # 여러 JSON 파일을 하나로 병합, dl_idx 정보 보존
    def coco_to_yolo_format(self, merged_data)           # COCO bbox를 YOLO 형식으로 변환, 매핑 파일 생성
    def _process_split(self, images, ann_by_image, output_dir, split_name)  # 훈련/검증 분할 처리
    def process_data(self)                               # 전체 전처리 파이프라인 실행

class RTDETRTrainer:
    # RT-DETR 모델 학습을 담당하는 클래스
    def __init__(self, data_yaml_path)                   # 데이터셋 YAML 파일 경로 설정
    def train(self, epochs, imgsz, batch)                # RT-DETR 모델 학습 실행
    def load_best_model(self, model_path)                # 최적 성능 모델 로드

class RTDETRInference:
    # 학습된 모델로 추론 및 제출 파일 생성하는 클래스
    def __init__(self, model_path, mapping_file_path)    # 모델 로드 및 YOLO→dl_idx 매핑 파일 로드
    def predict_and_generate_csv(self, test_images_path, output_csv_path, conf_thresh)  # 테스트 추론 및 CSV 생성
```

### 3.2 핵심 함수
```python
# 간단 버전 함수들 (함수형 프로그래밍 방식)
def quick_data_prep(data_path)           # COCO→YOLO 변환 및 매핑 파일 생성 (간단 버전)
def train_model(dataset_yaml, epochs, batch)    # RT-DETR 모델 학습 (간단 버전)
def create_submission(model_path, test_path, output_csv, mapping_file, conf_thresh)  # 추론 및 CSV 생성 (간단 버전)

# 통합 실행 함수들
def run_detailed_pipeline(data_path)     # 클래스 기반 상세 파이프라인 실행
def run_simple_pipeline(data_path)       # 함수 기반 간단 파이프라인 실행
def main(mode, data_path)               # 메인 실행 함수 (mode: "simple" 또는 "detailed")
```

### 3.3 데이터 플로우
```python
# 전처리: COCO → YOLO + 매핑 파일 생성
merged_data = processor.merge_coco_annotations()
processor.coco_to_yolo_format(merged_data)

# 학습: Ultralytics RT-DETR
model = RTDETR('rtdetr-l.pt')
results = model.train(data=dataset_yaml, epochs=50, batch=8)

# 추론: 매핑 적용한 CSV 생성
inference = RTDETRInference(model_path, mapping_file)
submission_df = inference.predict_and_generate_csv(test_path, output_csv)
```

## 4. 실험 결과

### 4.1 학습 설정
- **모델**: RT-DETR-L (Large)
- **에포크**: 50 (39번째 조기 종료)
- **배치 크기**: 8
- **이미지 크기**: 640×640
- **데이터셋**: 73개 알약 클래스
- **신뢰도 임계값**: 0.25

### 4.2 성능 지표 (최종 에포크 기준)

| 메트릭 | 값 | 해석 |
|--------|-----|------|
| **mAP50** | 0.361 | IoU 0.5에서 평균 정밀도 36.1% |
| **mAP50-95** | 0.361 | IoU 0.5-0.95 평균 정밀도 36.1% |
| **Precision** | 0.253 | 정밀도 25.3% (낮음) |
| **Recall** | 0.995 | 재현율 99.5% (높음) |

### 4.3 학습 안정성
- **손실 수렴**: 모든 손실 함수가 안정적으로 감소
- **과적합 여부**: 검증 손실이 훈련 손실을 추종하여 과적합 징후 없음
- **학습 효율성**: 20 에포크 이후 성능 지표가 수렴

### 4.4 클래스별 성능 분석
- **총 클래스**: 65개 알약 종류
- **클래스 불균형**: 일부 클래스는 200+ 샘플, 일부는 10개 미만
- **혼동행렬**: 대부분의 예측이 올바른 클래스로 집중되나, 일부 혼동 존재

### 4.5 예측 결과 분석
- **탐지 품질**: 대부분의 알약이 정확히 탐지됨
- **신뢰도 분포**: 0.3-0.6 범위에 집중
- **거짓 양성**: 정밀도가 낮아 불필요한 탐지 다수 발생

## 5. 문제점 및 개선 방향

### 5.1 현재 문제점

#### 주요 문제
1. **낮은 정밀도 (25.3%)**
   - 과도한 거짓 양성 탐지
   - 신뢰도 임계값이 너무 낮음 (0.25)

2. **클래스 불균형**
   - 일부 알약은 200개 이상, 일부는 10개 미만
   - 소수 클래스의 학습 부족

3. **하이퍼파라미터 최적화 부족**
   - 신뢰도 임계값 미조정
   - NMS 임계값 최적화 필요

#### 부차적 문제
- 모델 크기 대비 성능 향상 여지
- 이미지 해상도 최적화 필요
- 후처리 알고리즘 개선 여지

### 5.2 단계별 개선 방안

#### Phase 1: 즉시 개선
**목표**: Precision 25% → 45%
- 신뢰도 임계값 0.25 → 0.4 상향 조정
- NMS 임계값 최적화 (0.7 → 0.5)
- 최소 박스 크기 필터링 적용

#### Phase 2: 데이터 개선
**목표**: mAP50 36% → 42%
- 클래스 불균형 해결 (데이터 증강, 가중치 조정)
- 소수 클래스 데이터 증강 (회전, 색상 변경)
- 어노테이션 품질 검증 및 정제

#### Phase 3: 모델 업그레이드
**목표**: mAP50 42% → 48%
- RT-DETR-L → RT-DETR-X 모델 업그레이드
- 이미지 해상도 640 → 1024 증가
- 백본 네트워크 강화

#### Phase 4: 하이퍼파라미터 최적화
**목표**: mAP50 48% → 52%
- 학습률 스케줄링 최적화
- 배치 크기 및 에포크 수 조정
- 손실 함수 가중치 튜닝

#### Phase 5: 고급 기법
**목표**: mAP50 52% → 56%+
- 모델 앙상블 (여러 크기 모델 조합)
- TTA (Test Time Augmentation) 적용
- 의료 이미지 특화 전처리 기법

### 5.3 예상 성능 향상

| 개선 단계 | mAP50 | Precision | 주요 기법 |
|----------|-------|-----------|----------|
| 현재 | 36.1% | 25.3% | - |
| Phase 1 | 34.0% | 45.0% | 임계값 최적화 |
| Phase 2 | 42.0% | 50.0% | 데이터 균형화 |
| Phase 3 | 48.0% | 55.0% | 모델 업그레이드 |
| Phase 4 | 52.0% | 60.0% | 하이퍼파라미터 |
| Phase 5 | 56.0%+ | 65.0%+ | 앙상블 |

### 5.4 우선순위 개선 방향
1. **즉시 실행**: 신뢰도 임계값 0.4로 상향 조정
2. **단기 목표**: 클래스 불균형 해결을 통한 전체적 성능 향상  
3. **중기 목표**: 모델 크기 증대 및 해상도 향상
4. **장기 목표**: 앙상블 및 도메인 특화 최적화

## 6. 결론

RT-DETR 모델은 알약 객체 탐지 태스크에서 36.1%의 mAP50를 달성하여 기본적인 탐지 능력을 입증했습니다. 하지만 25.3%의 낮은 정밀도는 과도한 거짓 양성 탐지 문제를 나타내며, 이는 신뢰도 임계값 조정을 통해 즉시 개선 가능합니다.

단계별 개선 계획을 통해 최종적으로 mAP50 56%+, Precision 65%+ 달성이 가능할 것으로 예상되며, 이는 실용적인 의료용 알약 인식 시스템으로서의 성능 요구사항을 충족할 수 있는 수준입니다.

**핵심 성공 요인**: 
- 즉시 적용 가능한 임계값 최적화
- 체계적인 클래스 불균형 해결
- 단계적 모델 및 하이퍼파라미터 개선

---
*작성자: 지동진*
*보고서 작성일: 2025년 9월 19일*  
*모델 버전: RT-DETR-L*  
*데이터셋: 73개 알약 클래스*
